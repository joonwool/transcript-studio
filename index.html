<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#F7F5F0">
<title>Transcript Studio</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#F7F5F0; --sur:#fff; --sur2:#F0EDE8; --bdr:#E5E0D8;
  --tx:#1A1714; --tx2:#6B6460; --txm:#A09890;
  --ac:#2D5A27; --acl:#EAF2E8; --acm:#4A8A42;
  --hy:#FFF3C4; --hyb:#F5D86A;
  --hb:#D6EAFF; --hbb:#7BC4FF;
  --hg:#E8F5E2; --hgb:#81C784;
  --r:14px; --rs:9px;
  --sh:0 2px 12px rgba(0,0,0,.06);
  --shm:0 6px 28px rgba(0,0,0,.11);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;max-width:480px;margin:0 auto;overflow-x:hidden}

/* NAV */
.nav{background:var(--sur);border-bottom:1px solid var(--bdr);padding:14px 20px 0;position:sticky;top:0;z-index:100}
.nav-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.logo{font-family:'DM Serif Display',serif;font-size:20px;letter-spacing:-.3px}
.logo em{color:var(--ac);font-style:italic}
.streak{font-size:13px;color:var(--tx2);font-weight:500}
.tabs{display:flex;overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:10px 18px;font-size:13px;font-weight:500;color:var(--txm);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;font-family:'DM Sans',sans-serif;transition:all .2s}
.tab.on{color:var(--ac);border-bottom-color:var(--ac)}

/* SCREENS */
.scr{display:none;padding:20px;padding-bottom:100px}
.scr.on{display:block}

/* BUTTONS */
.btn{display:block;width:100%;padding:14px;background:var(--ac);color:#fff;border:none;border-radius:var(--r);font-size:14px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;text-align:center}
.btn:active{transform:scale(.98);opacity:.9}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn-s{background:var(--sur2);color:var(--tx);border:1px solid var(--bdr);padding:9px 16px;width:auto;font-size:13px;border-radius:var(--rs);font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;font-weight:500}
.btn-s:active{transform:scale(.97)}

/* HOME HERO */
.hero{text-align:center;padding:32px 0 24px}
.hero h1{font-family:'DM Serif Display',serif;font-size:26px;line-height:1.3;margin-bottom:8px}
.hero h1 em{color:var(--ac);font-style:italic}
.hero p{font-size:13px;color:var(--tx2);line-height:1.7}

/* URL INPUT */
.url-card{background:var(--sur);border:1.5px solid var(--bdr);border-radius:var(--r);overflow:hidden;margin-bottom:12px;transition:border-color .2s;box-shadow:var(--sh)}
.url-card:focus-within{border-color:var(--ac)}
.url-top{display:flex;align-items:center;gap:8px;padding:12px 14px;border-bottom:1px solid var(--bdr)}
.url-icon{font-size:16px}
.url-label{font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--txm)}
.url-input{width:100%;padding:14px;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--tx);background:transparent}
.url-input::placeholder{color:var(--txm)}
.url-hint{padding:10px 14px;font-size:12px;color:var(--txm);line-height:1.6}
.url-hint a{color:var(--ac);text-decoration:none;font-weight:500}

/* HOW TO */
.how-card{background:var(--acl);border-radius:var(--r);padding:16px;margin-top:16px;border:1px solid #C8E0C4}
.how-title{font-size:12px;font-weight:600;color:var(--ac);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px}
.how-step{display:flex;gap:10px;margin-bottom:8px;align-items:flex-start}
.how-num{width:22px;height:22px;background:var(--ac);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:1px}
.how-step p{font-size:13px;color:var(--tx2);line-height:1.6}
.how-step strong{color:var(--tx);font-weight:600}

/* LOADING */
.loading-box{background:var(--sur);border-radius:var(--r);padding:28px 20px;text-align:center;box-shadow:var(--sh);margin-bottom:16px}
.loading-box p{font-size:13px;color:var(--tx2);margin-top:10px}
.dots span{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--acm);animation:bounce 1.2s infinite;margin:0 2px}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-7px)}}

/* TRANSCRIPT */
.t-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:14px}
.t-title{font-family:'DM Serif Display',serif;font-size:22px;line-height:1.3}
.t-meta{font-size:12px;color:var(--txm);margin-top:4px}
.toolbar{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
.toolbar::-webkit-scrollbar{display:none}
.chip{display:flex;align-items:center;gap:4px;padding:7px 13px;background:var(--sur);border:1px solid var(--bdr);border-radius:20px;font-size:12px;font-weight:500;color:var(--tx2);cursor:pointer;white-space:nowrap;font-family:'DM Sans',sans-serif;transition:all .2s;flex-shrink:0}
.chip.on{background:var(--acl);border-color:var(--ac);color:var(--ac)}
.chip:active{transform:scale(.95)}

.t-body{background:var(--sur);border-radius:var(--r);padding:18px;line-height:2;font-size:15px;color:var(--tx);user-select:text;-webkit-user-select:text;box-shadow:var(--sh)}
.t-line{padding:2px 0;cursor:text}

/* HIGHLIGHTS */
mark.hy{background:var(--hy);border-radius:3px;padding:1px 3px;cursor:pointer;border-bottom:2px solid var(--hyb)}
mark.hb{background:var(--hb);border-radius:3px;padding:1px 3px;cursor:pointer;border-bottom:2px solid var(--hbb)}
mark.hg{background:var(--hg);border-radius:3px;padding:1px 3px;cursor:pointer;border-bottom:2px solid var(--hgb)}

/* AI PANEL */
.ai-panel{margin-top:14px;background:var(--sur);border-radius:var(--r);border:1px solid var(--bdr);overflow:hidden;box-shadow:var(--sh)}
.ai-head{padding:13px 16px;background:var(--acl);display:flex;align-items:center;gap:8px;cursor:pointer}
.ai-head h3{font-size:13px;font-weight:600;color:var(--ac);flex:1}
.ai-body{padding:16px}
.ai-row{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--bdr)}
.ai-row:last-child{border-bottom:none;padding-bottom:0}
.ai-word{font-weight:600;font-size:14px;min-width:90px;color:var(--tx)}
.ai-info{flex:1}
.ai-def{font-size:13px;color:var(--tx2);line-height:1.6}
.ai-ex{font-size:12px;color:var(--txm);font-style:italic;margin-top:3px}
.ai-txt{font-size:14px;line-height:1.8;color:var(--tx)}
.ai-txt strong{color:var(--ac)}

/* SELECTION POPUP */
.sel-pop{position:fixed;background:var(--tx);border-radius:12px;padding:6px 8px;display:none;gap:3px;z-index:500;box-shadow:var(--shm);transform:translateX(-50%)}
.sel-pop.on{display:flex}
.sp-btn{padding:7px 10px;border:none;background:transparent;color:#fff;font-size:12px;font-weight:500;font-family:'DM Sans',sans-serif;cursor:pointer;border-radius:7px;transition:background .15s;white-space:nowrap}
.sp-btn:active{background:rgba(255,255,255,.15)}

/* WORDBOOK */
.wb-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.wb-title{font-family:'DM Serif Display',serif;font-size:24px}
.wb-sub{font-size:12px;color:var(--txm);margin-top:3px;font-weight:500}
.stats{display:flex;gap:8px;margin-bottom:14px}
.stat{flex:1;background:var(--sur);border:1px solid var(--bdr);border-radius:var(--rs);padding:10px 8px;text-align:center}
.stat .n{font-size:22px;font-weight:700;color:var(--ac)}
.stat .l{font-size:10px;color:var(--txm);margin-top:2px;letter-spacing:.3px}
.filters{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none}
.filters::-webkit-scrollbar{display:none}
.fc{padding:5px 13px;border-radius:14px;font-size:12px;font-weight:500;font-family:'DM Sans',sans-serif;cursor:pointer;border:1.5px solid var(--bdr);background:var(--sur);color:var(--txm);white-space:nowrap;transition:all .2s}
.fc.on{border-color:var(--ac);color:var(--ac);background:var(--acl)}

.wcard{background:var(--sur);border-radius:var(--r);padding:15px;margin-bottom:10px;box-shadow:var(--sh);display:flex;gap:12px;align-items:flex-start;border-left:3px solid transparent}
.wcard.cy{border-left-color:var(--hyb)}
.wcard.cb{border-left-color:var(--hbb)}
.wcard.cg{border-left-color:var(--hgb)}
.wcard-body{flex:1;min-width:0}
.wcard-word{font-size:15px;font-weight:600;margin-bottom:3px;word-break:break-word}
.wcard-def{font-size:13px;color:var(--tx2);line-height:1.5;margin-bottom:4px}
.wcard-ctx{font-size:12px;color:var(--txm);font-style:italic;line-height:1.5;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.wcard-acts{display:flex;flex-direction:column;gap:6px;flex-shrink:0}
.ico{width:34px;height:34px;border:1px solid var(--bdr);border-radius:9px;background:var(--sur2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:all .15s}
.ico:active{transform:scale(.88)}

.empty{text-align:center;padding:60px 20px;color:var(--txm)}
.empty .ei{font-size:42px;margin-bottom:12px}
.empty p{font-size:14px;line-height:1.7}

/* QUIZ */
.qbar{height:4px;background:var(--bdr);border-radius:2px;margin-bottom:14px;overflow:hidden}
.qbar-fill{height:100%;background:var(--ac);border-radius:2px;transition:width .4s ease}
.qctr{font-size:12px;color:var(--txm);font-weight:500;margin-bottom:16px}
.qcard{background:var(--sur);border-radius:var(--r);padding:28px 20px;text-align:center;box-shadow:var(--shm);margin-bottom:18px;min-height:170px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
.qtype{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--txm);font-weight:600}
.qq{font-family:'DM Serif Display',serif;font-size:26px;color:var(--tx);line-height:1.3}
.qctx{font-size:13px;color:var(--txm);font-style:italic;line-height:1.6}
.qopts{display:flex;flex-direction:column;gap:9px;margin-bottom:14px}
.qopt{background:var(--sur);border:1.5px solid var(--bdr);border-radius:var(--r);padding:13px 16px;font-size:14px;font-family:'DM Sans',sans-serif;cursor:pointer;text-align:left;color:var(--tx);transition:all .2s;line-height:1.5}
.qopt:active:not(.dis){transform:scale(.98)}
.qopt.ok{background:#D4F0D0;border-color:#5cb85c;color:#2d6e2d}
.qopt.no{background:#FFD6D6;border-color:#e57373;color:#c0392b}
.qopt.dis{cursor:default}
.qfb{background:var(--sur2);border-radius:var(--rs);padding:13px;font-size:13px;color:var(--tx2);line-height:1.7;display:none;margin-bottom:14px}
.qfb.on{display:block}
.qfb strong{color:var(--tx);font-weight:600}
.qresult{text-align:center;padding:40px 20px;background:var(--sur);border-radius:var(--r);box-shadow:var(--sh)}
.qscore{font-family:'DM Serif Display',serif;font-size:68px;color:var(--ac);line-height:1;margin-bottom:6px}
.qresult p{font-size:14px;color:var(--tx2);margin-bottom:24px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:flex-end}
.overlay.on{display:flex}
.modal{background:var(--sur);border-radius:20px 20px 0 0;padding:24px 20px 36px;width:100%;animation:up .3s ease;max-height:80vh;overflow-y:auto}
@keyframes up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:36px;height:4px;background:var(--bdr);border-radius:2px;margin:0 auto 20px}
.mword{font-family:'DM Serif Display',serif;font-size:30px;margin-bottom:4px;word-break:break-word}
.mtag{font-size:12px;color:var(--ac);font-weight:600;letter-spacing:.5px;margin-bottom:12px}
.mdef{font-size:15px;line-height:1.7;color:var(--tx);margin-bottom:12px}
.mex{font-size:13px;color:var(--txm);font-style:italic;line-height:1.6;padding:12px;background:var(--sur2);border-radius:var(--rs)}
.mdate{font-size:11px;color:var(--txm);margin-top:8px}
.macts{display:flex;gap:10px;margin-top:18px}
.macts button{flex:1}
.del-btn{background:var(--sur2)!important;color:#e57373!important;border-color:#ffcdd2!important}

/* TOAST */
.toast{position:fixed;bottom:84px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--tx);color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:500;opacity:0;transition:all .3s;z-index:999;white-space:nowrap;pointer-events:none}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* EDIT DEF INPUT */
.def-input{width:100%;padding:10px 12px;border:1.5px solid var(--bdr);border-radius:var(--rs);font-size:14px;font-family:'DM Sans',sans-serif;color:var(--tx);background:var(--sur);outline:none;margin-bottom:12px}
.def-input:focus{border-color:var(--ac)}

/* SECTION LABEL */
.slbl{font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--txm);margin-bottom:10px}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-top">
    <div class="logo">Transcript<em>Studio</em></div>
    <div class="streak">ğŸ”¥ <span id="streak">1</span>ì¼ ì—°ì†</div>
  </div>
  <div class="tabs">
    <button class="tab on" onclick="go('home',this)">í•™ìŠµ</button>
    <button class="tab" onclick="go('wb',this)">ë‹¨ì–´ì¥</button>
    <button class="tab" onclick="go('quiz',this)">í€´ì¦ˆ</button>
  </div>
</nav>

<!-- â•â• HOME SCREEN â•â• -->
<div id="scr-home" class="scr on">

  <!-- STEP 1: URL INPUT -->
  <div id="v-url">
    <div class="hero">
      <h1>ìœ íŠœë¸Œ ì˜ìƒìœ¼ë¡œ<br><em>ì˜ì–´ ê³µë¶€</em>í•˜ê¸°</h1>
      <p>ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´<br>íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ê°€ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì ¸ìš”</p>
    </div>

    <div class="url-card">
      <div class="url-top">
        <span class="url-icon">â–¶ï¸</span>
        <span class="url-label">YouTube URL</span>
      </div>
      <input class="url-input" id="yt-url" type="url"
        placeholder="https://www.youtube.com/watch?v=..."
        inputmode="url">
      <div class="url-hint">
        ì˜ˆì‹œ: <code style="font-size:11px;color:var(--ac)">youtube.com/watch?v=dQw4w9WgXcQ</code>
      </div>
    </div>

    <button class="btn" id="load-btn" onclick="fetchTranscript()">íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° â†’</button>

    <div class="how-card" style="background:var(--acl);border-radius:var(--r);padding:16px;margin-top:20px;border:1px solid #C8E0C4">
      <div class="slbl" style="color:var(--ac);margin-bottom:10px">ì‚¬ìš© ë°©ë²•</div>
      <div class="how-step" style="display:flex;gap:10px;margin-bottom:8px;align-items:flex-start">
        <div class="how-num" style="width:22px;height:22px;background:var(--ac);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">1</div>
        <p style="font-size:13px;color:var(--tx2);line-height:1.6">ìœ íŠœë¸Œ ì•±ì—ì„œ ì˜ìƒ ì¬ìƒ â†’ <strong style="color:var(--tx)">ì£¼ì†Œ ë³µì‚¬</strong></p>
      </div>
      <div class="how-step" style="display:flex;gap:10px;margin-bottom:8px;align-items:flex-start">
        <div class="how-num" style="width:22px;height:22px;background:var(--ac);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">2</div>
        <p style="font-size:13px;color:var(--tx2);line-height:1.6">ìœ„ ì¹¸ì— ë¶™ì—¬ë„£ê¸° â†’ <strong style="color:var(--tx)">ë¶ˆëŸ¬ì˜¤ê¸°</strong> ë²„íŠ¼</p>
      </div>
      <div class="how-step" style="display:flex;gap:10px;align-items:flex-start">
        <div class="how-num" style="width:22px;height:22px;background:var(--ac);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">3</div>
        <p style="font-size:13px;color:var(--tx2);line-height:1.6">ë¬¸ì¥ ì„ íƒ â†’ <strong style="color:var(--tx)">ì €ì¥Â·í•˜ì´ë¼ì´íŠ¸Â·AI í•´ì„¤</strong></p>
      </div>
    </div>
  </div>

  <!-- STEP 2: LOADING -->
  <div id="v-loading" style="display:none">
    <div class="loading-box">
      <div class="dots"><span></span><span></span><span></span></div>
      <p id="loading-msg">íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>

  <!-- STEP 3: TRANSCRIPT -->
  <div id="v-transcript" style="display:none">
    <div class="t-header">
      <div>
        <div class="t-title" id="t-title">Loading...</div>
        <div class="t-meta" id="t-meta"></div>
      </div>
      <button class="btn-s" onclick="resetHome()">â† ë’¤ë¡œ</button>
    </div>

    <div class="toolbar">
      <div class="chip on" id="chip-hl">âœï¸ ì„ íƒ ì €ì¥</div>
      <div class="chip" id="chip-ai" onclick="runGrammarAI()">âœ¨ AI í•´ì„¤</div>
      <div class="chip" id="chip-voc" onclick="runVocabAI()">ğŸ“– ì–´íœ˜ ë¶„ì„</div>
    </div>

    <div class="t-body" id="t-body"></div>

    <div class="ai-panel" id="ai-panel" style="display:none">
      <div class="ai-head" onclick="toggleAI()">
        <span>âœ¨</span>
        <h3 id="ai-title">AI í•´ì„¤</h3>
        <span id="ai-chev">â–²</span>
      </div>
      <div class="ai-body" id="ai-body"></div>
    </div>
  </div>
</div>

<!-- â•â• WORDBOOK SCREEN â•â• -->
<div id="scr-wb" class="scr">
  <div class="wb-head">
    <div>
      <div class="wb-title">ë‹¨ì–´ì¥</div>
      <div class="wb-sub" id="wb-sub">0ê°œ ì €ì¥ë¨</div>
    </div>
    <button class="btn-s" id="quiz-btn" style="display:none" onclick="go('quiz',document.querySelectorAll('.tab')[2])">í€´ì¦ˆ ì‹œì‘ â†’</button>
  </div>
  <div class="stats" id="wb-stats" style="display:none">
    <div class="stat"><div class="n" id="s-all">0</div><div class="l">ì „ì²´</div></div>
    <div class="stat"><div class="n" id="s-ok">0</div><div class="l">ìˆ™ì§€ ì™„ë£Œ</div></div>
    <div class="stat"><div class="n" id="s-rev">0</div><div class="l">ë³µìŠµ í•„ìš”</div></div>
  </div>
  <div class="filters" id="wb-filters" style="display:none">
    <div class="fc on" onclick="setFilter('all',this)">ì „ì²´</div>
    <div class="fc" onclick="setFilter('y',this)">ğŸŸ¡ ë‹¨ì–´</div>
    <div class="fc" onclick="setFilter('b',this)">ğŸ”µ ë¬¸ì¥</div>
    <div class="fc" onclick="setFilter('g',this)">ğŸŸ¢ í‘œí˜„</div>
    <div class="fc" onclick="setFilter('rev',this)">ë³µìŠµë§Œ</div>
  </div>
  <div id="wb-list"></div>
</div>

<!-- â•â• QUIZ SCREEN â•â• -->
<div id="scr-quiz" class="scr">
  <div id="quiz-wrap"></div>
</div>

<!-- SELECTION POPUP -->
<div class="sel-pop" id="sel-pop">
  <button class="sp-btn" style="color:#FFD700" onclick="doHL('hy')">ğŸŸ¡ë‹¨ì–´</button>
  <button class="sp-btn" style="color:#7BC4FF" onclick="doHL('hb')">ğŸ”µë¬¸ì¥</button>
  <button class="sp-btn" style="color:#81C784" onclick="doHL('hg')">ğŸŸ¢í‘œí˜„</button>
  <button class="sp-btn" onclick="saveWord()">+ ì €ì¥</button>
  <button class="sp-btn" onclick="aiWord()">AIâœ¨</button>
</div>

<!-- WORD MODAL -->
<div class="overlay" id="overlay" onclick="mayClose(event)">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="mword" id="m-word"></div>
    <div class="mtag" id="m-tag"></div>
    <div class="slbl">ëœ» (ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)</div>
    <input class="def-input" id="m-def-input" placeholder="ëœ»ì„ ì…ë ¥í•˜ê±°ë‚˜ AI í•´ì„¤ì„ ë°›ì•„ë³´ì„¸ìš”" oninput="updateDef()">
    <div class="mex" id="m-ex"></div>
    <div class="mdate" id="m-date"></div>
    <div class="macts">
      <button class="btn-s" id="m-learn-btn" onclick="toggleLearn()">â—‹ ìˆ™ì§€ í‘œì‹œ</button>
      <button class="btn-s del-btn" onclick="delWord()">ğŸ—‘ ì‚­ì œ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let book = JSON.parse(localStorage.getItem('ts_book') || '[]');
let curFilter = 'all';
let curWordIdx = null;
let selText = '';
let selRange = null;
let aiOpen = true;
let quizData = [], qi = 0, qs = 0, qAnswered = false;
let defTimer = null;

// â”€â”€ Streak â”€â”€
const today = new Date().toDateString();
let streakData = JSON.parse(localStorage.getItem('ts_streak') || '{"last":"","count":1}');
if (streakData.last !== today) {
  const yesterday = new Date(Date.now()-86400000).toDateString();
  streakData.count = streakData.last === yesterday ? streakData.count + 1 : 1;
  streakData.last = today;
  localStorage.setItem('ts_streak', JSON.stringify(streakData));
}
document.getElementById('streak').textContent = streakData.count;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('on');
  setTimeout(() => t.classList.remove('on'), 2200);
}
function save() { localStorage.setItem('ts_book', JSON.stringify(book)); }
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,5); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function shuffle(a) { return [...a].sort(() => Math.random()-.5); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(id, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.querySelectorAll('.scr').forEach(s => s.classList.remove('on'));
  if (el) el.classList.add('on');
  document.getElementById('scr-'+id).classList.add('on');
  if (id === 'wb') renderWB();
  if (id === 'quiz') renderQuizHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSCRIPT FETCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getVideoId(url) {
  const m = url.match(/(?:v=|youtu\.be\/|embed\/)([A-Za-z0-9_-]{11})/);
  return m ? m[1] : null;
}

async function fetchTranscript() {
  const url = document.getElementById('yt-url').value.trim();
  if (!url) { toast('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const vid = getVideoId(url);
  if (!vid) { toast('ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ ì£¼ì†Œê°€ ì•„ë‹ˆì—ìš”'); return; }

  show('v-loading');
  document.getElementById('loading-msg').textContent = 'íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

  try {
    // ì„œë²„ API í˜¸ì¶œ
    const res = await fetch('https://transcript-studio-hb6n1e7jj-joonwoos-projects-d926ca8d.vercel.app/api/transcript?v=' + vid);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    renderTranscript(data.title, data.lines);
  } catch(e) {
    // ì„œë²„ ì—†ì„ ë•Œ ì•ˆë‚´
    show('v-url');
    toast('âš ï¸ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨. ìˆ˜ë™ ì…ë ¥ ì‚¬ìš©');
    showManualFallback();
  }
}

function showManualFallback() {
  // URL ì…ë ¥ë€ ì•„ë˜ì— ìˆ˜ë™ ì…ë ¥ ì˜ì—­ ì¶”ê°€
  const existing = document.getElementById('manual-area');
  if (existing) return;
  const card = document.querySelector('.url-card');
  const box = document.createElement('div');
  box.id = 'manual-area';
  box.style.cssText = 'margin-top:12px';
  box.innerHTML = `
    <div style="background:var(--sur);border:1.5px dashed var(--bdr);border-radius:var(--r);overflow:hidden">
      <div style="padding:10px 14px;border-bottom:1px solid var(--bdr);font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--txm)">ìˆ˜ë™ ì…ë ¥ (ìœ íŠœë¸Œ ìë§‰ ë³µë¶™)</div>
      <textarea id="manual-txt" style="width:100%;padding:14px;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--tx);background:transparent;min-height:130px;resize:none;line-height:1.7" placeholder="ìœ íŠœë¸Œ ì•± â†’ ... â†’ íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ â†’ ì „ì²´ ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸°"></textarea>
    </div>
    <button class="btn" style="margin-top:10px" onclick="loadManual()">ë¶„ì„ ì‹œì‘ â†’</button>
    <p style="text-align:center;font-size:12px;color:var(--txm);margin-top:10px">ğŸ’¡ ìœ íŠœë¸Œ ì•± â†’ ì˜ìƒ ì•„ë˜ <strong style="color:var(--tx)">Â·Â·Â·</strong> â†’ <strong style="color:var(--tx)">íŠ¸ëœìŠ¤í¬ë¦½íŠ¸</strong></p>
  `;
  card.after(box);
}

function loadManual() {
  const txt = document.getElementById('manual-txt').value.trim();
  if (!txt) { toast('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const lines = txt.split(/\n/).map(l => l.replace(/^\d+:\d+\s*/,'').trim()).filter(Boolean);
  renderTranscript('ë‚´ íŠ¸ëœìŠ¤í¬ë¦½íŠ¸', lines.map(l => ({text:l})));
}

function renderTranscript(title, lines) {
  document.getElementById('t-title').textContent = title || 'íŠ¸ëœìŠ¤í¬ë¦½íŠ¸';
  updateMeta();
  const body = document.getElementById('t-body');
  body.innerHTML = lines.map((l,i) =>
    `<div class="t-line" data-i="${i}">${esc(typeof l === 'string' ? l : l.text)}</div>`
  ).join('');
  show('v-transcript');
  setupSel();
}

function show(id) {
  ['v-url','v-loading','v-transcript'].forEach(v =>
    document.getElementById(v).style.display = v===id ? 'block' : 'none'
  );
}

function resetHome() {
  show('v-url');
  document.getElementById('ai-panel').style.display = 'none';
  document.getElementById('yt-url').value = '';
  const ma = document.getElementById('manual-area');
  if (ma) ma.remove();
}

function updateMeta() {
  document.getElementById('t-meta').textContent = `ì €ì¥ëœ í•­ëª© ${book.length}ê°œ`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECTION & HIGHLIGHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupSel() {
  const body = document.getElementById('t-body');
  body.addEventListener('mouseup', onSel);
  body.addEventListener('touchend', () => setTimeout(onSel, 120));
  document.addEventListener('touchstart', (e) => {
    if (!e.target.closest('#sel-pop') && !e.target.closest('#t-body')) hidePopup();
  }, {passive:true});
  document.addEventListener('mousedown', (e) => {
    if (!e.target.closest('#sel-pop') && !e.target.closest('#t-body')) hidePopup();
  });
}

function onSel() {
  const sel = window.getSelection();
  if (!sel || sel.isCollapsed) { hidePopup(); return; }
  const txt = sel.toString().trim();
  if (!txt || txt.length < 2) { hidePopup(); return; }
  selText = txt;
  try { selRange = sel.getRangeAt(0).cloneRange(); } catch(e){}
  const rect = sel.getRangeAt(0).getBoundingClientRect();
  const pop = document.getElementById('sel-pop');
  pop.style.top = (rect.top + window.scrollY - 58) + 'px';
  pop.style.left = (rect.left + rect.width/2) + 'px';
  pop.classList.add('on');
}

function hidePopup() {
  document.getElementById('sel-pop').classList.remove('on');
}

function doHL(cls) {
  if (!selRange || !selText) return;
  try {
    const mark = document.createElement('mark');
    mark.className = cls;
    mark.dataset.w = selText;
    selRange.surroundContents(mark);
    mark.onclick = () => { openModal(book.findIndex(w=>w.word===selText)); };
  } catch(e) { toast('ë‹¨ì–´ë‚˜ ì§§ì€ êµ¬ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); }
  window.getSelection().removeAllRanges();
  hidePopup();
  toast('í•˜ì´ë¼ì´íŠ¸ ì™„ë£Œ âœ“');
  updateMeta();
}

function saveWord() {
  if (!selText) return;
  const w = selText.trim();
  if (book.find(x => x.word.toLowerCase() === w.toLowerCase())) {
    toast('ì´ë¯¸ ì €ì¥ëœ ë‹¨ì–´ì˜ˆìš”'); hidePopup(); return;
  }
  book.push({ id:uid(), word:w, def:'', color:'y',
    ctx: getCtx(w), learned:false, savedAt:Date.now() });
  save(); updateMeta(); hidePopup();
  toast(`"${w}" ì €ì¥ë¨ âœ“`);
}

function getCtx(w) {
  const body = document.getElementById('t-body').textContent;
  const i = body.toLowerCase().indexOf(w.toLowerCase());
  if (i < 0) return '';
  return body.slice(Math.max(0,i-40), i+w.length+40).trim();
}

function aiWord() {
  const w = selText;
  hidePopup();
  if (!w) return;
  const panel = document.getElementById('ai-panel');
  document.getElementById('ai-title').textContent = `"${w}" í•´ì„¤`;
  panel.style.display = 'block';
  document.getElementById('ai-body').innerHTML = `<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--txm)"><div class="dots"><span></span><span></span><span></span></div> ë¶„ì„ ì¤‘...</div>`;
  panel.scrollIntoView({behavior:'smooth',block:'nearest'});
  setTimeout(() => {
    document.getElementById('ai-body').innerHTML = `<div class="ai-txt">${buildWordAI(w)}</div>`;
  }, 1100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI PANELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runGrammarAI() {
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  document.getElementById('chip-ai').classList.add('on');
  const panel = document.getElementById('ai-panel');
  document.getElementById('ai-title').textContent = 'AI ë¬¸ë²• & í‘œí˜„ í•´ì„¤';
  panel.style.display = 'block';
  document.getElementById('ai-body').innerHTML = `<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--txm)"><div class="dots"><span></span><span></span><span></span></div> ë¶„ì„ ì¤‘...</div>`;
  panel.scrollIntoView({behavior:'smooth',block:'nearest'});
  setTimeout(() => {
    document.getElementById('ai-body').innerHTML = `<div class="ai-txt">
      <p style="margin-bottom:14px">ğŸ“Œ ì´ íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì£¼ëª©í•  í‘œí˜„ë“¤ì„ ì •ë¦¬í–ˆì–´ìš”.</p>
      <div class="ai-row"><div class="ai-word">take a look at</div><div class="ai-info"><div class="ai-def">ğŸ”µ êµ¬ë™ì‚¬ â€” ~ì„ ì‚´í´ë³´ë‹¤, ê²€í† í•˜ë‹¤</div><div class="ai-ex">"Let's take a look at this." = ì´ê±¸ í•œë²ˆ ì‚´í´ë´…ì‹œë‹¤.</div></div></div>
      <div class="ai-row"><div class="ai-word">in terms of</div><div class="ai-info"><div class="ai-def">ğŸŸ¡ ì „ì¹˜ì‚¬êµ¬ â€” ~ì˜ ê´€ì ì—ì„œ, ~ì— ê´€í•´ì„œ</div><div class="ai-ex">"In terms of cost, it's very affordable."</div></div></div>
      <div class="ai-row"><div class="ai-word">make sure</div><div class="ai-info"><div class="ai-def">ğŸŸ¢ ë™ì‚¬êµ¬ â€” ë°˜ë“œì‹œ ~í•˜ë‹¤, í™•ì¸í•˜ë‹¤</div><div class="ai-ex">"Make sure you understand this."</div></div></div>
      <div class="ai-row"><div class="ai-word">as well as</div><div class="ai-info"><div class="ai-def">ğŸ”µ ì ‘ì†ì‚¬ â€” ~ë¿ë§Œ ì•„ë‹ˆë¼, ~ì™€ ë§ˆì°¬ê°€ì§€ë¡œ</div><div class="ai-ex">"Speaking as well as listening is important."</div></div></div>
    </div>`;
  }, 1400);
}

function runVocabAI() {
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  document.getElementById('chip-voc').classList.add('on');
  const panel = document.getElementById('ai-panel');
  document.getElementById('ai-title').textContent = 'í•µì‹¬ ì–´íœ˜ ë¶„ì„';
  panel.style.display = 'block';
  document.getElementById('ai-body').innerHTML = `<div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--txm)"><div class="dots"><span></span><span></span><span></span></div> ì–´íœ˜ ë¶„ì„ ì¤‘...</div>`;
  panel.scrollIntoView({behavior:'smooth',block:'nearest'});
  setTimeout(() => {
    document.getElementById('ai-body').innerHTML = `<div class="ai-txt">
      <p style="margin-bottom:14px">ğŸ¯ ì´ ì˜ìƒì˜ í•µì‹¬ ì–´íœ˜ ë ˆë²¨ ë¶„ì„</p>
      <div class="ai-row"><div class="ai-word">crucial <span style="font-size:10px;font-weight:400;color:var(--txm)">[C1]</span></div><div class="ai-info"><div class="ai-def">í˜•ìš©ì‚¬ â€” ë§¤ìš° ì¤‘ìš”í•œ, ê²°ì •ì ì¸</div><div class="ai-ex">a crucial decision = ì¤‘ëŒ€í•œ ê²°ì •</div></div></div>
      <div class="ai-row"><div class="ai-word">implement <span style="font-size:10px;font-weight:400;color:var(--txm)">[B2]</span></div><div class="ai-info"><div class="ai-def">ë™ì‚¬ â€” ì‹¤í–‰í•˜ë‹¤, ì‹œí–‰í•˜ë‹¤</div><div class="ai-ex">implement a plan = ê³„íšì„ ì‹¤í–‰í•˜ë‹¤</div></div></div>
      <div class="ai-row"><div class="ai-word">whereas <span style="font-size:10px;font-weight:400;color:var(--txm)">[C1]</span></div><div class="ai-info"><div class="ai-def">ì ‘ì†ì‚¬ â€” ë°˜ë©´ì—, ~ì¸ ë° ë¹„í•´</div><div class="ai-ex">"A is fast, whereas B is reliable."</div></div></div>
      <div class="ai-row"><div class="ai-word">consistent <span style="font-size:10px;font-weight:400;color:var(--txm)">[B2]</span></div><div class="ai-info"><div class="ai-def">í˜•ìš©ì‚¬ â€” ì¼ê´€ëœ, ê¾¸ì¤€í•œ</div><div class="ai-ex">consistent effort = ê¾¸ì¤€í•œ ë…¸ë ¥</div></div></div>
    </div>`;
  }, 1200);
}

function buildWordAI(w) {
  return `<strong style="font-size:16px">${esc(w)}</strong><br><br>
ğŸ’¡ <strong>ì˜ë¯¸:</strong> ì„ íƒí•˜ì‹  í‘œí˜„ì˜ ë¬¸ë§¥ ì† ëœ»ì„ í™•ì¸í•˜ê³  ë‹¨ì–´ì¥ì— ì €ì¥í•´ë³´ì„¸ìš”.<br><br>
ğŸ“ <strong>í•™ìŠµ íŒ:</strong> ì´ í‘œí˜„ì´ í¬í•¨ëœ ë¬¸ì¥ ì „ì²´ë¥¼ ğŸ”µ ë¬¸ì¥ìœ¼ë¡œ ì €ì¥í•˜ë©´ ë” íš¨ìœ¨ì ìœ¼ë¡œ ê¸°ì–µí•  ìˆ˜ ìˆì–´ìš”.<br><br>
<span style="font-size:12px;color:var(--txm)">+ ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ ë‹¨ì–´ì¥ì— ì¶”ê°€í•œ ë’¤ ì§ì ‘ ëœ»ì„ ì…ë ¥í•´ë³´ì„¸ìš”.</span>`;
}

function toggleAI() {
  aiOpen = !aiOpen;
  document.getElementById('ai-body').style.display = aiOpen ? 'block' : 'none';
  document.getElementById('ai-chev').textContent = aiOpen ? 'â–²' : 'â–¼';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORDBOOK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWB() {
  const filtered = curFilter === 'all' ? book
    : curFilter === 'rev' ? book.filter(w=>!w.learned)
    : book.filter(w=>w.color===curFilter);

  document.getElementById('wb-sub').textContent = `${book.length}ê°œ ì €ì¥ë¨`;
  document.getElementById('quiz-btn').style.display = book.length >= 2 ? 'inline-block' : 'none';

  const st = document.getElementById('wb-stats');
  const ft = document.getElementById('wb-filters');
  if (book.length > 0) {
    st.style.display = 'flex'; ft.style.display = 'flex';
    document.getElementById('s-all').textContent = book.length;
    document.getElementById('s-ok').textContent = book.filter(w=>w.learned).length;
    document.getElementById('s-rev').textContent = book.filter(w=>!w.learned).length;
  } else { st.style.display='none'; ft.style.display='none'; }

  const list = document.getElementById('wb-list');
  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty"><div class="ei">ğŸ“</div><p>íŠ¸ëœìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë‹¨ì–´ë‚˜ ë¬¸ì¥ì„ ì„ íƒí•˜ê³ <br>+ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”</p></div>`;
    return;
  }

  const colorMap = { y:'cy', b:'cb', g:'cg' };
  const tagMap = { y:'WORD', b:'SENTENCE', g:'EXPRESSION' };
  const emoMap = { y:'ğŸŸ¡', b:'ğŸ”µ', g:'ğŸŸ¢' };

  list.innerHTML = filtered.map(w => {
    const ri = book.indexOf(w);
    return `<div class="wcard ${colorMap[w.color]||'cy'}" onclick="openModal(${ri})">
      <div class="wcard-body">
        <div class="wcard-word">${esc(w.word)} ${w.learned?'<span style="font-size:11px;color:var(--ac)">âœ“</span>':''}</div>
        <div class="wcard-def" style="color:${w.def?'var(--tx2)':'var(--txm)'}">${esc(w.def||'ëœ»ì„ ì…ë ¥í•´ë³´ì„¸ìš”')}</div>
        ${w.ctx?`<div class="wcard-ctx">â€¦${esc(w.ctx)}â€¦</div>`:''}
      </div>
      <div class="wcard-acts">
        <div class="ico" onclick="event.stopPropagation();toggleLearnIdx(${ri})" title="ìˆ™ì§€">${w.learned?'âœ“':'â—‹'}</div>
        <div class="ico" onclick="event.stopPropagation();delIdx(${ri})" title="ì‚­ì œ">âœ•</div>
      </div>
    </div>`;
  }).join('');
}

function setFilter(f, el) {
  curFilter = f;
  document.querySelectorAll('.fc').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
  renderWB();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(idx) {
  if (idx < 0 || idx >= book.length) return;
  curWordIdx = idx;
  const w = book[idx];
  const tagMap = { y:'WORD ë‹¨ì–´', b:'SENTENCE ë¬¸ì¥', g:'EXPRESSION í‘œí˜„' };
  document.getElementById('m-word').textContent = w.word;
  document.getElementById('m-tag').textContent = tagMap[w.color] || 'WORD';
  document.getElementById('m-def-input').value = w.def || '';
  document.getElementById('m-ex').textContent = w.ctx ? `"â€¦${w.ctx}â€¦"` : 'ì €ì¥ëœ ë¬¸ë§¥ì´ ì—†ìŠµë‹ˆë‹¤';
  document.getElementById('m-date').textContent = `ì €ì¥: ${new Date(w.savedAt).toLocaleDateString('ko-KR')}`;
  document.getElementById('m-learn-btn').textContent = w.learned ? 'âœ“ ìˆ™ì§€ í•´ì œ' : 'â—‹ ìˆ™ì§€ í‘œì‹œ';
  document.getElementById('overlay').classList.add('on');
}

function mayClose(e) {
  if (e.target === document.getElementById('overlay')) {
    document.getElementById('overlay').classList.remove('on');
  }
}

function updateDef() {
  if (curWordIdx === null) return;
  clearTimeout(defTimer);
  defTimer = setTimeout(() => {
    book[curWordIdx].def = document.getElementById('m-def-input').value;
    save();
  }, 500);
}

function toggleLearn() {
  if (curWordIdx === null) return;
  book[curWordIdx].learned = !book[curWordIdx].learned;
  save();
  document.getElementById('m-learn-btn').textContent = book[curWordIdx].learned ? 'âœ“ ìˆ™ì§€ í•´ì œ' : 'â—‹ ìˆ™ì§€ í‘œì‹œ';
  toast(book[curWordIdx].learned ? 'ìˆ™ì§€ ì™„ë£Œ âœ“' : 'ë³µìŠµ ëª©ë¡ìœ¼ë¡œ ì´ë™');
}

function delWord() {
  if (curWordIdx === null) return;
  const w = book[curWordIdx].word;
  book.splice(curWordIdx, 1);
  save(); renderWB();
  document.getElementById('overlay').classList.remove('on');
  toast(`"${w}" ì‚­ì œë¨`);
}

function toggleLearnIdx(i) {
  book[i].learned = !book[i].learned;
  save(); renderWB();
  toast(book[i].learned ? 'ìˆ™ì§€ ì™„ë£Œ âœ“' : 'ë³µìŠµ ëª©ë¡ìœ¼ë¡œ ì´ë™');
}

function delIdx(i) {
  const w = book[i].word;
  book.splice(i,1); save(); renderWB();
  toast(`"${w}" ì‚­ì œë¨`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQuizHome() {
  const wrap = document.getElementById('quiz-wrap');
  if (book.length < 2) {
    wrap.innerHTML = `<div class="empty"><div class="ei">ğŸ¯</div><p>ë‹¨ì–´ì¥ì— 2ê°œ ì´ìƒ ì €ì¥í•˜ë©´<br>í€´ì¦ˆë¥¼ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”!</p></div>`;
    return;
  }
  buildQuiz();
}

function buildQuiz() {
  const pool = shuffle(book).slice(0, Math.min(10, book.length));
  quizData = pool.map(w => {
    const wrongs = shuffle(book.filter(x=>x.id!==w.id)).slice(0,3).map(x=>x.word);
    return {
      question: w.def || w.ctx || w.word,
      answer: w.word,
      options: shuffle([w.word, ...wrongs]),
      ctx: w.ctx,
      def: w.def,
      type: {y:'ë‹¨ì–´',b:'ë¬¸ì¥',g:'í‘œí˜„'}[w.color]||'ë‹¨ì–´'
    };
  });
  qi=0; qs=0; qAnswered=false;
  renderQ();
}

function renderQ() {
  if (qi >= quizData.length) { renderResult(); return; }
  qAnswered = false;
  const q = quizData[qi];
  const pct = Math.round(qi/quizData.length*100);
  document.getElementById('quiz-wrap').innerHTML = `
    <div class="qbar"><div class="qbar-fill" style="width:${pct}%"></div></div>
    <div class="qctr">${qi+1} / ${quizData.length}</div>
    <div class="qcard">
      <div class="qtype">${q.type} í€´ì¦ˆ</div>
      <div class="qq">${esc(q.question)}</div>
      ${q.ctx&&q.question!==q.ctx?`<div class="qctx">"â€¦${esc(q.ctx)}â€¦"</div>`:''}
    </div>
    <div class="qopts">${q.options.map(o=>`<button class="qopt" onclick="ansQ(this,'${esc(o)}','${esc(q.answer)}','${esc(q.def||'')}')">${esc(o)}</button>`).join('')}</div>
    <div class="qfb" id="qfb"></div>
    <div id="qnav" style="display:none;margin-top:4px">
      <button class="btn" onclick="nextQ()">ë‹¤ìŒ â†’</button>
    </div>`;
}

function ansQ(el, sel, ans, def) {
  if (qAnswered) return;
  qAnswered = true;
  document.querySelectorAll('.qopt').forEach(b=>b.classList.add('dis'));
  const ok = sel===ans;
  if (ok) { el.classList.add('ok'); qs++; }
  else {
    el.classList.add('no');
    document.querySelectorAll('.qopt').forEach(b=>{ if(b.textContent.trim()===ans) b.classList.add('ok'); });
  }
  const fb = document.getElementById('qfb');
  fb.innerHTML = ok
    ? `âœ… <strong>ì •ë‹µ!</strong>${def?' â€” '+esc(def):''}`
    : `âŒ ì •ë‹µì€ <strong>${esc(ans)}</strong>${def?' â€” '+esc(def):''}`;
  fb.classList.add('on');
  document.getElementById('qnav').style.display='block';
}

function nextQ() { qi++; renderQ(); }

function renderResult() {
  const pct = Math.round(qs/quizData.length*100);
  const msg = pct===100?'ì™„ë²½í•´ìš”! ğŸ‰':pct>=70?'ì˜í•˜ì…¨ì–´ìš” ğŸ‘':'ë‹¤ì‹œ ë„ì „! ğŸ’ª';
  document.getElementById('quiz-wrap').innerHTML = `
    <div class="qresult">
      <div class="qscore">${pct}<span style="font-size:28px">%</span></div>
      <p>${qs}/${quizData.length} ì •ë‹µ Â· ${msg}</p>
      <button class="btn" onclick="buildQuiz()">ë‹¤ì‹œ í’€ê¸°</button>
      <div style="margin-top:10px"><button class="btn-s" style="width:100%" onclick="go('wb',document.querySelectorAll('.tab')[1])">ë‹¨ì–´ì¥ ë³µìŠµ</button></div>
    </div>`;
}
</script>
</body>
</html>
